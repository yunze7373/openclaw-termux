name: Notify on CI Failure

on:
  workflow_run:
    workflows: ["CI/CD Auto Check", "AI Code Review"]
    types: [completed]
    branches: [main, dev]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
    - name: Get workflow details
      id: workflow
      run: |
        echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
        echo "run_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        echo "commit=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
        
    - name: Send Telegram notification
      if: ${{ secrets.TELEGRAM_BOT_TOKEN && secrets.TELEGRAM_CHAT_ID }}
      run: |
        MESSAGE="ğŸš¨ CI/CD å¤±è´¥é€šçŸ¥
        
å·¥ä½œæµ: ${{ steps.workflow.outputs.workflow_name }}
åˆ†æ”¯: ${{ steps.workflow.outputs.branch }}
æäº¤: ${{ steps.workflow.outputs.commit }}

æŸ¥çœ‹è¯¦æƒ…: ${{ steps.workflow.outputs.run_url }}"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$MESSAGE" \
          -d parse_mode="HTML"
      continue-on-error: true
    
    - name: Create issue on repeated failures
      if: ${{ github.event.workflow_run.run_attempt > 2 }}
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ CI/CD æŒç»­å¤±è´¥: ${{ steps.workflow.outputs.workflow_name }}`,
            body: `å·¥ä½œæµ **${{ steps.workflow.outputs.workflow_name }}** åœ¨åˆ†æ”¯ \`${{ steps.workflow.outputs.branch }}\` ä¸Šè¿ç»­å¤±è´¥ ${{ github.event.workflow_run.run_attempt }} æ¬¡ã€‚
            
**è¯¦æƒ…:**
- æäº¤: ${{ steps.workflow.outputs.commit }}
- è¿è¡Œåœ°å€: ${{ steps.workflow.outputs.run_url }}

è¯·å°½å¿«æ£€æŸ¥å¹¶ä¿®å¤ã€‚`,
            labels: ['ci-failure', 'automated']
          });
          console.log('Created issue:', issue.data.number);
