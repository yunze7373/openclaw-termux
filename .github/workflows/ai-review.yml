name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ 'feat/**', 'fix/**', 'docs/**' ]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v44
      with:
        files: |
          src/**/*.ts
          src/**/*.js
          scripts/**/*.sh
          *.md
    
    - name: Setup analysis environment
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "Changed files:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        
    - name: Check for security issues
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        # Check for common security issues
        echo "üîç Scanning for security issues..."
        
        # Check for exposed secrets
        if grep -r "api.key\|password\|secret\|token" ${{ steps.changed-files.outputs.all_changed_files }} 2>/dev/null | grep -v "example\|placeholder\|test"; then
          echo "‚ö†Ô∏è Potential secret exposure detected!"
          echo "::warning::Found potential secrets in changed files"
        fi
        
        # Check for eval/exec usage
        if grep -r "eval(\|exec(" ${{ steps.changed-files.outputs.all_changed_files }} 2>/dev/null; then
          echo "‚ö†Ô∏è Dangerous eval/exec usage detected!"
          echo "::warning::Found eval/exec in changed files"
        fi
        
    - name: Check code quality
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "üìä Checking code quality..."
        
        # Check for TODO/FIXME comments
        if grep -rn "TODO\|FIXME\|XXX\|HACK" ${{ steps.changed-files.outputs.all_changed_files }} 2>/dev/null; then
          echo "‚ÑπÔ∏è Found TODO/FIXME comments"
          echo "::notice::Consider addressing TODO/FIXME comments"
        fi
        
        # Check for console.log in production code
        if grep -rn "console\.log\|console\.debug" ${{ steps.changed-files.outputs.all_changed_files }} | grep -v "test\|spec" 2>/dev/null; then
          echo "‚ö†Ô∏è Found console.log in production code"
          echo "::warning::Remove console.log from production code"
        fi
        
    - name: Check Termux compatibility
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "üì± Checking Termux compatibility..."
        
        # Check for hardcoded /tmp paths
        if grep -rn "/tmp/" ${{ steps.changed-files.outputs.all_changed_files }} 2>/dev/null | grep -v "os.tmpdir\|tmpdir()"; then
          echo "‚ö†Ô∏è Hardcoded /tmp/ path found (use os.tmpdir())"
          echo "::warning::Found hardcoded /tmp paths - use os.tmpdir() for Termux compatibility"
        fi
        
        # Check for platform-specific commands
        if grep -rn "open \|pbcopy\|xdg-open" ${{ steps.changed-files.outputs.all_changed_files }} 2>/dev/null; then
          echo "‚ö†Ô∏è Platform-specific command found"
          echo "::warning::Found platform-specific commands - ensure cross-platform compatibility"
        fi

  auto-merge-docs:
    runs-on: ubuntu-latest
    needs: code-review
    if: startsWith(github.ref, 'refs/heads/docs/') && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Auto-merge to main
      run: |
        git checkout main
        git merge --no-ff ${{ github.ref_name }} -m "chore: auto-merge ${{ github.ref_name }} [skip ci]"
        git push origin main
      continue-on-error: true
